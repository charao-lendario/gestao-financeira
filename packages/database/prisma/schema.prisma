
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ClienteStatus {
  ATIVO
  INATIVO
}

enum FormaPagamento {
  A_VISTA
  PARCELADO
  MENSALIDADE
}

enum ContratoStatus {
  ATIVO
  FINALIZADO
  CANCELADO
}

enum ParcelaStatus {
  PREVISTO
  PAGO
  ATRASADO
  CANCELADO
}

enum FormaRecebimento {
  PIX
  TRANSFERENCIA
  BOLETO
  CHEQUE
  CARTAO
}

enum TipoMovimentacao {
  ENTRADA
  SAIDA
}

model Empresa {
  id            String             @id @default(uuid())
  nome          String
  cor           String?            @default("#e2e8f0")
  criadoEm      DateTime           @default(now())
  atualizadoEm  DateTime           @updatedAt
  cartoes       CartaoCredito[]
  rateios       RateioContrato[]
  movimentacoes MovimentacaoCaixa[]
}

model CartaoCredito {
  id            String    @id @default(uuid())
  nome          String
  finalCartao   String?
  bandeira      String?
  diaFechamento Int
  diaVencimento Int
  limite        Decimal?  @db.Decimal(12, 2)
  cor           String?   @default("#cbd5e1")
  empresaId     String
  empresa       Empresa   @relation(fields: [empresaId], references: [id])
  criadoEm      DateTime  @default(now())
  atualizadoEm  DateTime  @updatedAt
  parcelas      Parcela[]
}

model Cliente {
  id                 String         @id @default(uuid())
  clienteId          String         @unique // CLT-0001
  nome               String
  documento          String         @unique // CPF/CNPJ
  contatoNome        String?
  telefone           String?
  email              String?
  cidade             String?
  uf                 String?
  responsavelInterno String?
  status             ClienteStatus  @default(ATIVO)
  criadoEm           DateTime       @default(now())
  atualizadoEm       DateTime       @updatedAt
  contratos          Contrato[]
}

model Contrato {
  id                 String           @id @default(uuid())
  contratoId         String           @unique // CTR-2026-001
  clienteId          String
  nomeProjeto        String
  dataContrato       DateTime         @db.Date
  valorTotal         Decimal          @db.Decimal(12, 2)
  formaPagamento     FormaPagamento
  qtdParcelas        Int?
  diaVencimento      Int?             // 1-31
  dataInicioCobranca DateTime?        @db.Date
  dataFimCobranca    DateTime?        @db.Date
  observacoes        String?          @db.Text
  status             ContratoStatus   @default(ATIVO)
  criadoEm           DateTime         @default(now())
  atualizadoEm       DateTime         @updatedAt
  cliente            Cliente          @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  parcelas           Parcela[]
  rateio             RateioContrato[]

  @@index([clienteId])
}

model RateioContrato {
  id         String   @id @default(uuid())
  contratoId String
  contrato   Contrato @relation(fields: [contratoId], references: [id], onDelete: Cascade)
  empresaId  String
  empresa    Empresa  @relation(fields: [empresaId], references: [id])
  percentual Decimal  @db.Decimal(5, 2)
  criadoEm   DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@unique([contratoId, empresaId])
}

model Parcela {
  id               String            @id @default(uuid())
  parcelaId        String            @unique
  contratoId       String
  competencia      String            // "01/2026"
  numeroParcela    Int
  dataVencimento   DateTime          @db.Date
  valorPrevisto    Decimal           @db.Decimal(12, 2)
  dataPagamento    DateTime?         @db.Date
  valorPago        Decimal?          @db.Decimal(12, 2)
  status           ParcelaStatus     @default(PREVISTO)
  diasAtraso       Int               @default(0)
  formaRecebimento FormaRecebimento?
  comprovanteUrl   String?           @db.Text
  observacao       String?           @db.Text
  criadoEm         DateTime          @default(now())
  atualizadoEm     DateTime          @updatedAt
  contrato         Contrato          @relation(fields: [contratoId], references: [id], onDelete: Cascade)
  
  // Credit Card Relations
  cartaoId         String?
  cartao           CartaoCredito?    @relation(fields: [cartaoId], references: [id])
  
  movimentacoes    MovimentacaoCaixa[]

  @@index([contratoId])
  @@index([status])
  @@index([dataVencimento])
}

model MovimentacaoCaixa {
  id          String           @id @default(uuid())
  data        DateTime         @db.Date
  descricao   String
  valor       Decimal          @db.Decimal(12, 2)
  tipo        TipoMovimentacao
  empresaId   String
  empresa     Empresa          @relation(fields: [empresaId], references: [id])
  parcelaId   String?
  parcela     Parcela?         @relation(fields: [parcelaId], references: [id])
  criadoEm    DateTime         @default(now())
  atualizadoEm DateTime        @updatedAt

  @@index([data])
  @@index([empresaId])
}
